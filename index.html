
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bow Tie Risk Assessment Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .workflow-section {
            margin-bottom: 40px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border-left: 5px solid #3498db;
        }

        .workflow-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8em;
            font-weight: 400;
        }

        .bow-tie-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .bow-tie-section {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: transform 0.3s ease;
        }

        .bow-tie-section:hover {
            transform: translateY(-5px);
        }

        .threats { background: #ff6b6b; color: white; }
        .preventative { background: #4ecdc4; color: white; }
        .incident { background: #ffe66d; color: #333; }
        .mitigative { background: #95e1d3; color: #333; }
        .consequences { background: #ffa8a8; color: #333; }

        .bow-tie-section h3 {
            font-size: 1.2em;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .bow-tie-section .content {
            font-size: 0.9em;
            line-height: 1.4;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .cia-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .risk-matrix {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .risk-calculation {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .risk-score {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
        }

        .risk-very-high { background: #e74c3c; color: white; }
        .risk-high { background: #f39c12; color: white; }
        .risk-medium { background: #f1c40f; color: #333; }
        .risk-low { background: #2ecc71; color: white; }
        .risk-very-low { background: #27ae60; color: white; }

        .controls-section {
            margin: 30px 0;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .control-item {
            background: white;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-item:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15);
        }

        .control-item.selected {
            border-color: #2ecc71;
            background: #d5f4e6;
        }

        .control-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .comparison-table th, .comparison-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e6ed;
        }

        .comparison-table th {
            background: #34495e;
            color: white;
            font-weight: 600;
        }

        .risk-assessment-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .risk-assessment-table th, .risk-assessment-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e6ed;
            vertical-align: top;
        }

        .risk-assessment-table th {
            background: #34495e;
            color: white;
            font-weight: 600;
            width: 20%;
        }

        .gap-analysis {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .ofi-section {
            background: #d1ecf1;
            border: 1px solid #a2d2df;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .file-upload {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            background: #f8f9fa;
            border-color: #2980b9;
        }

        .hidden {
            display: none;
        }

        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            margin: 40px 0;
            border-radius: 1px;
        }

        @media (max-width: 768px) {
            .bow-tie-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .cia-grid {
                grid-template-columns: 1fr;
            }
            
            .risk-matrix {
                grid-template-columns: 1fr;
            }

            #bowTieModel {
                min-height: 300px;
            }

            .mobile-bow-tie {
                display: block !important;
            }

            .desktop-bow-tie {
                display: none !important;
            }
        }

        .bow-tie-threat {
            fill: #3498db;
            stroke: #2980b9;
            stroke-width: 2;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bow-tie-threat:hover {
            fill: #5dade2;
            transform: scale(1.05);
        }

        .bow-tie-preventative {
            fill: #2ecc71;
            stroke: #27ae60;
            stroke-width: 2;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bow-tie-preventative:hover {
            fill: #58d68d;
        }

        .bow-tie-preventative.selected {
            fill: #1abc9c;
            stroke: #16a085;
            stroke-width: 3;
        }

        .bow-tie-reactive {
            fill: #f39c12;
            stroke: #e67e22;
            stroke-width: 2;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bow-tie-reactive:hover {
            fill: #f7dc6f;
        }

        .bow-tie-reactive.selected {
            fill: #e67e22;
            stroke: #d35400;
            stroke-width: 3;
        }

        .bow-tie-event {
            fill: #e74c3c;
            stroke: #c0392b;
            stroke-width: 3;
        }

        .bow-tie-consequence {
            fill: #e67e22;
            stroke: #d35400;
            stroke-width: 2;
        }

        .control-barrier {
            stroke-width: 6;
            opacity: 0.8;
            transition: all 0.3s ease;
        }

        .control-barrier.high-effectiveness {
            stroke: #27ae60;
        }

        .control-barrier.medium-effectiveness {
            stroke: #f1c40f;
        }

        .control-barrier.low-effectiveness {
            stroke: #e74c3c;
        }

        .control-barrier.selected {
            opacity: 1;
            stroke-width: 10;
        }

        .bow-tie-text {
            font-family: 'Segoe UI', sans-serif;
            font-size: 12px;
            text-anchor: middle;
            fill: white;
            font-weight: 600;
        }

        .bow-tie-small-text {
            font-family: 'Segoe UI', sans-serif;
            font-size: 10px;
            text-anchor: middle;
            fill: #333;
            font-weight: 500;
        }

        .logical-flow-arrow {
            stroke: #34495e;
            stroke-width: 3;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            max-width: 250px;
        }

        /* Visual Risk Matrix Styles */
        .risk-matrix-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-width: 900px;
            margin: 0 auto;
        }

        .visual-risk-matrix {
            width: 100%;
            border-collapse: collapse;
            margin: 0 auto;
            font-size: 14px;
            background: white;
        }

        .visual-risk-matrix th, .visual-risk-matrix td {
            border: 2px solid #34495e;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            position: relative;
            min-height: 50px;
        }

        .matrix-corner {
            background: #34495e;
            color: white;
            font-size: 12px;
            width: 120px;
        }

        .matrix-header {
            background: #34495e;
            color: white;
            font-size: 13px;
            padding: 8px 4px;
        }

        .consequence-header {
            background: #34495e;
            color: white;
            font-size: 11px;
            padding: 8px 4px;
            min-width: 80px;
        }

        .likelihood-header {
            background: #34495e;
            color: white;
            font-size: 12px;
            text-align: center;
            writing-mode: horizontal-tb;
            width: 120px;
        }

        .matrix-cell {
            position: relative;
            height: 60px;
            width: 80px;
            font-size: 12px;
            font-weight: 700;
            cursor: default;
            transition: all 0.3s ease;
        }

        .matrix-cell.low {
            background: #27ae60;
            color: white;
        }

        .matrix-cell.medium {
            background: #f1c40f;
            color: #2c3e50;
        }

        .matrix-cell.high {
            background: #e67e22;
            color: white;
        }

        .matrix-cell.extreme {
            background: #e74c3c;
            color: white;
        }

        /* Risk position markers */
        .risk-position {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            z-index: 10;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .risk-position.before {
            background: #2c3e50;
            color: white;
            top: 8px;
            left: 8px;
        }

        .risk-position.after {
            background: #8e44ad;
            color: white;
            top: 8px;
            right: 8px;
        }

        .risk-arrow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            color: #2c3e50;
            font-weight: bold;
            z-index: 5;
            text-shadow: 1px 1px 2px white;
        }

        .matrix-legend {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e6ed;
        }

        .matrix-legend h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .legend-items {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #2c3e50;
        }

        .legend-marker {
            font-size: 18px;
            font-weight: bold;
        }

        .before-marker {
            color: #2c3e50;
        }

        .after-marker {
            color: #8e44ad;
        }

        .arrow-marker {
            color: #2c3e50;
        }

        /* Matrix cell highlighting */
        .matrix-cell.current-before {
            box-shadow: inset 0 0 0 4px #2c3e50;
        }

        .matrix-cell.current-after {
            box-shadow: inset 0 0 0 4px #8e44ad;
        }

        .matrix-cell.has-movement {
            animation: riskMovement 2s ease-in-out;
        }

        @keyframes riskMovement {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @media (max-width: 768px) {
            .visual-risk-matrix {
                font-size: 10px;
            }
            
            .matrix-cell {
                height: 50px;
                width: 60px;
                font-size: 10px;
            }
            
            .risk-position {
                width: 16px;
                height: 16px;
                font-size: 12px;
            }
            
            .legend-items {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Bow Tie Risk Assessment Tool</h1>
            <p>Identify compensating controls, control gaps, and opportunities for improvement</p>
        </div>

        <div class="main-content">
            <!-- Step 1: Load Scenario -->
            <div class="workflow-section">
                <h2>Step 1: Load Bow Tie Scenario</h2>
                
                <div class="file-upload">
                    <p><strong>üìÅ Custom JSON Configuration (Optional)</strong></p>
                    <p>Upload your custom threats, controls, and consequences configuration</p>
                    <input type="file" id="jsonUpload" accept=".json" style="margin-top: 10px;">
                    <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        Using default NIST CSF 2.0 controls. You can customize by uploading JSON files with your internal capability framework.
                    </p>
                </div>

                <div class="bow-tie-container" id="bowTieVisualization">
                    <div class="bow-tie-section threats">
                        <h3>Threats</h3>
                        <div class="content" id="threatsContent">
                            <strong>External Threat:</strong><br>
                            Advanced Persistent Threat (APT) targeting critical infrastructure through phishing and lateral movement
                        </div>
                    </div>
                    
                    <div class="bow-tie-section preventative">
                        <h3>Preventative Controls</h3>
                        <div class="content" id="preventativeContent">
                            <strong>NIST CSF 2.0:</strong><br>
                            ‚Ä¢ ID.AM - Asset Management<br>
                            ‚Ä¢ PR.AC - Identity & Access Control<br>
                            ‚Ä¢ PR.AT - Awareness & Training<br>
                            ‚Ä¢ PR.DS - Data Security
                        </div>
                    </div>
                    
                    <div class="bow-tie-section incident">
                        <h3>Incident/Security Event</h3>
                        <div class="content" id="incidentContent">
                            <strong>Potential Events:</strong><br>
                            ‚Ä¢ Unauthorized system access<br>
                            ‚Ä¢ Data exfiltration<br>
                            ‚Ä¢ System compromise<br>
                            ‚Ä¢ Service disruption
                        </div>
                    </div>
                    
                    <div class="bow-tie-section mitigative">
                        <h3>Mitigative/Reactive Controls</h3>
                        <div class="content" id="mitigativeContent">
                            <strong>NIST CSF 2.0:</strong><br>
                            ‚Ä¢ DE.AE - Anomalies & Events<br>
                            ‚Ä¢ RS.RP - Response Planning<br>
                            ‚Ä¢ RS.CO - Communications<br>
                            ‚Ä¢ RC.RP - Recovery Planning
                        </div>
                    </div>
                    
                    <div class="bow-tie-section consequences">
                        <h3>Consequences</h3>
                        <div class="content" id="consequencesContent">
                            <strong>Potential Outcomes:</strong><br>
                            ‚Ä¢ Loss of critical assets/resiliency (Availability, Integrity)<br>
                            ‚Ä¢ Data loss/leakage (Confidentiality, Integrity)<br>
                            ‚Ä¢ Regulatory compliance issues<br>
                            ‚Ä¢ Reputational damage
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-divider"></div>

            <!-- Step 2: Load Finding -->
            <div class="workflow-section">
                <h2>Step 2: Load Your Finding</h2>
                
                <div class="form-group">
                    <label for="findingTitle">Finding Title:</label>
                    <input type="text" id="findingTitle" placeholder="e.g., Insufficient Email Security Controls">
                </div>

                <div class="form-group">
                    <label for="findingDescription">Finding Description:</label>
                    <textarea id="findingDescription" rows="4" placeholder="Detailed description of the security finding..."></textarea>
                </div>

                <div class="form-group">
                    <label for="assetName">Asset Name:</label>
                    <input type="text" id="assetName" placeholder="e.g., Email Infrastructure, Customer Database">
                </div>

                <div class="form-group">
                    <label>Asset Criticality & Sensitivity (CIA Scores out of 5):</label>
                    <div class="cia-grid">
                        <div>
                            <label for="confidentiality">Confidentiality:</label>
                            <select id="confidentiality">
                                <option value="1">1 - Public</option>
                                <option value="2">2 - Internal</option>
                                <option value="3" selected>3 - Confidential</option>
                                <option value="4">4 - Restricted</option>
                                <option value="5">5 - Top Secret</option>
                            </select>
                        </div>
                        <div>
                            <label for="integrity">Integrity:</label>
                            <select id="integrity">
                                <option value="1">1 - Minimal</option>
                                <option value="2">2 - Low</option>
                                <option value="3" selected>3 - Moderate</option>
                                <option value="4">4 - High</option>
                                <option value="5">5 - Critical</option>
                            </select>
                        </div>
                        <div>
                            <label for="availability">Availability:</label>
                            <select id="availability">
                                <option value="1">1 - Minimal</option>
                                <option value="2">2 - Low</option>
                                <option value="3" selected>3 - Moderate</option>
                                <option value="4">4 - High</option>
                                <option value="5">5 - Critical</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-divider"></div>

            <!-- Step 3: Assess Current Risk -->
            <div class="workflow-section">
                <h2>Step 3: Assess Current Risk</h2>
                
                <div class="risk-matrix">
                    <div class="form-group">
                        <label for="likelihood">Likelihood:</label>
                        <select id="likelihood">
                            <option value="5">1 - Almost Certain (multiple times per year)</option>
                            <option value="4">2 - Likely (at least once per year)</option>
                            <option value="3" selected>3 - Possible (once between 1-5 years)</option>
                            <option value="2">2 - Unlikely (once between 5-10 years)</option>
                            <option value="1">1 - Rare (perhaps once in 10 years)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="impact">Impact:</label>
                        <select id="impact">
                            <option value="5">1 - Extreme impact on C/I/A</option>
                            <option value="4" selected>2 - Major impact on C/I/A</option>
                            <option value="3">3 - Moderate impact on C/I/A</option>
                            <option value="2">4 - Minor impact on C/I/A</option>
                            <option value="1">5 - Insignificant impact on C/I/A</option>
                        </select>
                    </div>
                </div>

                <div class="risk-calculation">
                    <h3>Current Risk Assessment</h3>
                    <div class="risk-score" id="currentRiskScore">Risk Score: 12</div>
                    <div id="currentRiskLevel">High Risk</div>
                </div>

                <!-- New Risk Assessment Table -->
                <table class="risk-assessment-table">
                    <thead>
                        <tr>
                            <th>Risk Description</th>
                            <th>Inherent Evaluation</th>
                            <th>Control Measures</th>
                            <th>Residual Evaluation</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="riskDescription">
                                <strong>Risk Description</strong><br>
                                <span style="font-size: 0.9em; color: #666;">Loading...</span>
                            </td>
                            <td id="inherentEvaluation">
                                <div style="background: #95a5a6; padding: 15px; border-radius: 8px; color: white; font-weight: bold;">
                                    Not calculated
                                </div>
                            </td>
                            <td id="controlsList">
                                <em style="color: #666;">No compensating controls applied yet</em>
                            </td>
                            <td id="residualEvaluation">
                                <div style="background: #95a5a6; padding: 15px; border-radius: 8px; color: white; font-weight: bold;">
                                    Not calculated
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <button class="btn btn-primary" onclick="calculateCurrentRisk()">Calculate Current Risk</button>
            </div>

            <div class="section-divider"></div>

            <!-- Step 4: Apply Compensating Controls -->
            <div class="workflow-section">
                <h2>Step 4: Apply Compensating Controls</h2>
                
                <div class="controls-section">
                    <h3>üìã Preventative Controls</h3>
                    <p style="margin-bottom: 20px; color: #666; font-style: italic;">Controls that help prevent security events from occurring</p>
                    <div class="controls-grid" id="preventativeControlsGrid">
                        <!-- Preventative controls will be dynamically populated -->
                    </div>
                </div>

                <div class="section-divider" style="margin: 30px 0;"></div>

                <div class="controls-section">
                    <h3>üö® Reactive/Mitigative Controls</h3>
                    <p style="margin-bottom: 20px; color: #666; font-style: italic;">Controls that minimize impact by enabling better detection, response, and recovery</p>
                    <div class="controls-grid" id="reactiveControlsGrid">
                        <!-- Reactive controls will be dynamically populated -->
                    </div>
                </div>

                <button class="btn btn-success" onclick="applyCompensatingControls()">Apply Selected Controls</button>
            </div>

            <div class="section-divider"></div>

            <!-- Step 5: Compare Risks -->
            <div class="workflow-section">
                <h2>Step 5: Risk Comparison & Analysis</h2>
                
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Assessment</th>
                            <th>Likelihood</th>
                            <th>Impact</th>
                            <th>Risk Score</th>
                            <th>Risk Level</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Before Controls</strong></td>
                            <td id="beforeLikelihood">3</td>
                            <td id="beforeImpact">4</td>
                            <td id="beforeScore">12</td>
                            <td id="beforeLevel">High Risk</td>
                        </tr>
                        <tr>
                            <td><strong>After Controls</strong></td>
                            <td id="afterLikelihood">-</td>
                            <td id="afterImpact">-</td>
                            <td id="afterScore">-</td>
                            <td id="afterLevel">-</td>
                        </tr>
                    </tbody>
                </table>

                <!-- Visual Risk Matrix -->
                <div style="margin: 30px 0; text-align: center;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">üìä Visual Risk Matrix</h3>
                    <div class="risk-matrix-container">
                        <table class="visual-risk-matrix">
                            <thead>
                                <tr>
                                    <th rowspan="2" class="matrix-corner">Likelihood Rating</th>
                                    <th colspan="5" class="matrix-header">Consequences - Maximum Reasonable Consequence</th>
                                </tr>
                                <tr>
                                    <th class="consequence-header">Insignificant</th>
                                    <th class="consequence-header">Minor</th>
                                    <th class="consequence-header">Moderate</th>
                                    <th class="consequence-header">Major</th>
                                    <th class="consequence-header">Catastrophic</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <th class="likelihood-header">Almost Certain</th>
                                    <td class="matrix-cell medium" data-likelihood="5" data-impact="1">Medium</td>
                                    <td class="matrix-cell medium" data-likelihood="5" data-impact="2">Medium</td>
                                    <td class="matrix-cell high" data-likelihood="5" data-impact="3">High</td>
                                    <td class="matrix-cell extreme" data-likelihood="5" data-impact="4">Extreme</td>
                                    <td class="matrix-cell extreme" data-likelihood="5" data-impact="5">Extreme</td>
                                </tr>
                                <tr>
                                    <th class="likelihood-header">Likely</th>
                                    <td class="matrix-cell low" data-likelihood="4" data-impact="1">Low</td>
                                    <td class="matrix-cell medium" data-likelihood="4" data-impact="2">Medium</td>
                                    <td class="matrix-cell medium" data-likelihood="4" data-impact="3">Medium</td>
                                    <td class="matrix-cell high" data-likelihood="4" data-impact="4">High</td>
                                    <td class="matrix-cell extreme" data-likelihood="4" data-impact="5">Extreme</td>
                                </tr>
                                <tr>
                                    <th class="likelihood-header">Possible</th>
                                    <td class="matrix-cell low" data-likelihood="3" data-impact="1">Low</td>
                                    <td class="matrix-cell low" data-likelihood="3" data-impact="2">Low</td>
                                    <td class="matrix-cell medium" data-likelihood="3" data-impact="3">Medium</td>
                                    <td class="matrix-cell high" data-likelihood="3" data-impact="4">High</td>
                                    <td class="matrix-cell high" data-likelihood="3" data-impact="5">High</td>
                                </tr>
                                <tr>
                                    <th class="likelihood-header">Unlikely</th>
                                    <td class="matrix-cell low" data-likelihood="2" data-impact="1">Low</td>
                                    <td class="matrix-cell low" data-likelihood="2" data-impact="2">Low</td>
                                    <td class="matrix-cell low" data-likelihood="2" data-impact="3">Low</td>
                                    <td class="matrix-cell medium" data-likelihood="2" data-impact="4">Medium</td>
                                    <td class="matrix-cell high" data-likelihood="2" data-impact="5">High</td>
                                </tr>
                                <tr>
                                    <th class="likelihood-header">Rare</th>
                                    <td class="matrix-cell low" data-likelihood="1" data-impact="1">Low</td>
                                    <td class="matrix-cell low" data-likelihood="1" data-impact="2">Low</td>
                                    <td class="matrix-cell low" data-likelihood="1" data-impact="3">Low</td>
                                    <td class="matrix-cell low" data-likelihood="1" data-impact="4">Low</td>
                                    <td class="matrix-cell medium" data-likelihood="1" data-impact="5">Medium</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <!-- Legend -->
                        <div class="matrix-legend">
                            <h4>Risk Matrix Legend</h4>
                            <div class="legend-items">
                                <div class="legend-item">
                                    <span class="legend-marker before-marker">‚óè</span>
                                    <span>BEFORE Controls</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-marker after-marker">‚óè</span>
                                    <span>AFTER Controls</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-marker arrow-marker">‚Üí</span>
                                    <span>Risk Movement</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="gap-analysis hidden" id="gapAnalysis">
                    <h3>üîç Gap Analysis</h3>
                    <div id="gapContent"></div>
                </div>

                <div class="ofi-section hidden" id="ofiSection">
                    <h3>üí° Opportunities for Improvement (OFI)</h3>
                    <div id="ofiContent"></div>
                </div>
            </div>

            <div class="section-divider"></div>

            <!-- Step 6: Document & Export -->
            <div class="workflow-section">
                <h2>Step 6: Document & Export</h2>
                
                <div class="form-group">
                    <label for="assessmentNotes">Assessment Notes:</label>
                    <textarea id="assessmentNotes" rows="4" placeholder="Additional notes, recommendations, or observations..."></textarea>
                </div>

                <button class="btn btn-success" onclick="exportAssessment()">üìÑ Export Assessment</button>
                <button class="btn btn-primary" onclick="saveSession()">üíæ Save Session</button>
                <button class="btn btn-warning" onclick="loadSession()">üìÇ Load Session</button>
            </div>

            <div class="section-divider"></div>

            <!-- Step 7: Interactive Bow Tie Model -->
            <div class="workflow-section">
                <h2>Step 7: Interactive Bow Tie Model</h2>
                
                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="generateBowTieModel()">üéØ Generate Interactive Bow Tie Model</button>
                    <button class="btn btn-success" onclick="exportBowTieModel('png')" id="exportPngBtn" style="display: none;">üì∏ Export as PNG</button>
                    <button class="btn btn-success" onclick="exportBowTieModel('svg')" id="exportSvgBtn" style="display: none;">üñºÔ∏è Export as SVG</button>
                </div>

                <div id="bowTieModelContainer" class="hidden" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow-x: auto;">
                    <svg id="bowTieModel" width="1200" height="600" viewBox="0 0 1200 600" style="width: 100%; height: auto; min-height: 400px;">
                        <!-- SVG content will be dynamically generated -->
                    </svg>
                </div>

                <div id="modelLegend" class="hidden" style="margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h4>Legend</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                        <div><span style="display: inline-block; width: 20px; height: 20px; background: #3498db; margin-right: 8px; border-radius: 3px;"></span>Threats</div>
                        <div><span style="display: inline-block; width: 20px; height: 20px; background: #2ecc71; margin-right: 8px; border-radius: 3px;"></span>Preventative Controls</div>
                        <div><span style="display: inline-block; width: 20px; height: 20px; background: #e74c3c; margin-right: 8px; border-radius: 3px;"></span>Security Event</div>
                        <div><span style="display: inline-block; width: 20px; height: 20px; background: #f39c12; margin-right: 8px; border-radius: 3px;"></span>Reactive Controls</div>
                        <div><span style="display: inline-block; width: 20px; height: 20px; background: #e67e22; margin-right: 8px; border-radius: 3px;"></span>Consequences</div>
                    </div>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        <strong>Control Effectiveness:</strong> Barrier height indicates risk reduction impact. 
                        Green barriers = High effectiveness, Yellow = Medium, Red = Low effectiveness.
                        Click controls to toggle selection, hover for details.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Default NIST CSF 2.0 Controls Data
        const defaultControls = {
            preventative: [
                { id: 'ID.AM', name: 'Asset Management', description: 'Identify and manage organizational assets', riskReduction: { likelihood: 0.5, impact: 0.2 } },
                { id: 'PR.AC', name: 'Identity & Access Control', description: 'Limit access to authorized users and processes', riskReduction: { likelihood: 0.7, impact: 0.3 } },
                { id: 'PR.AT', name: 'Awareness & Training', description: 'Provide cybersecurity education', riskReduction: { likelihood: 0.6, impact: 0.1 } },
                { id: 'PR.DS', name: 'Data Security', description: 'Protect data through appropriate safeguards', riskReduction: { likelihood: 0.4, impact: 0.5 } },
                { id: 'PR.IP', name: 'Information Protection', description: 'Maintain protective technology', riskReduction: { likelihood: 0.5, impact: 0.4 } },
                { id: 'PR.MA', name: 'Maintenance', description: 'Perform maintenance on systems', riskReduction: { likelihood: 0.3, impact: 0.2 } },
                { id: 'PR.PT', name: 'Protective Technology', description: 'Deploy technical security solutions', riskReduction: { likelihood: 0.8, impact: 0.3 } }
            ],
            mitigative: [
                { id: 'DE.AE', name: 'Anomalies & Events', description: 'Detect anomalous activity', riskReduction: { likelihood: 0.2, impact: 0.6 } },
                { id: 'DE.CM', name: 'Continuous Monitoring', description: 'Monitor systems continuously', riskReduction: { likelihood: 0.3, impact: 0.4 } },
                { id: 'RS.RP', name: 'Response Planning', description: 'Execute response procedures', riskReduction: { likelihood: 0.1, impact: 0.7 } },
                { id: 'RS.CO', name: 'Communications', description: 'Coordinate response activities', riskReduction: { likelihood: 0.2, impact: 0.5 } },
                { id: 'RS.AN', name: 'Analysis', description: 'Analyze events to understand impact', riskReduction: { likelihood: 0.1, impact: 0.6 } },
                { id: 'RC.RP', name: 'Recovery Planning', description: 'Execute recovery procedures', riskReduction: { likelihood: 0.1, impact: 0.8 } },
                { id: 'RC.IM', name: 'Improvements', description: 'Incorporate lessons learned', riskReduction: { likelihood: 0.4, impact: 0.3 } }
            ]
        };

        let currentAssessment = {
            finding: {},
            currentRisk: {},
            selectedControls: [],
            adjustedRisk: {},
            gaps: [],
            ofis: []
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadDefaultControls();
            setupEventListeners();
            // Initialize with default values
            calculateCurrentRisk();
        });

        function setupEventListeners() {
            const jsonUpload = document.getElementById('jsonUpload');
            const likelihood = document.getElementById('likelihood');
            const impact = document.getElementById('impact');
            
            if (jsonUpload) {
                jsonUpload.addEventListener('change', loadCustomConfiguration);
            }
            if (likelihood) {
                likelihood.addEventListener('change', calculateCurrentRisk);
            }
            if (impact) {
                impact.addEventListener('change', calculateCurrentRisk);
            }

            // Add change listeners for form fields to update risk table
            const formFields = ['findingTitle', 'findingDescription', 'assetName'];
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updateRiskTable);
                }
            });
        }

        function loadDefaultControls() {
            const preventativeGrid = document.getElementById('preventativeControlsGrid');
            const reactiveGrid = document.getElementById('reactiveControlsGrid');
            
            if (!preventativeGrid || !reactiveGrid) {
                console.error('Control grids not found');
                return;
            }

            // Clear existing content
            preventativeGrid.innerHTML = '';
            reactiveGrid.innerHTML = '';

            // Add preventative controls
            defaultControls.preventative.forEach(control => {
                const controlElement = createControlElement(control, 'preventative');
                preventativeGrid.appendChild(controlElement);
            });

            // Add reactive/mitigative controls
            defaultControls.mitigative.forEach(control => {
                const controlElement = createControlElement(control, 'mitigative');
                reactiveGrid.appendChild(controlElement);
            });
        }

        function createControlElement(control, type) {
            const div = document.createElement('div');
            div.className = 'control-item';
            div.innerHTML = `
                <input type="checkbox" id="${control.id}" data-type="${type}">
                <label for="${control.id}">
                    <strong>${control.id}: ${control.name}</strong><br>
                    <small>${control.description}</small><br>
                    <em>Risk Reduction: Likelihood(-${Math.round(control.riskReduction.likelihood * 100)}%) Impact(-${Math.round(control.riskReduction.impact * 100)}%)</em>
                </label>
            `;

            div.addEventListener('click', function(e) {
                if (e.target.type !== 'checkbox') {
                    const checkbox = div.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }
                }
                const checkbox = div.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    div.classList.toggle('selected', checkbox.checked);
                    updateControlMeasuresDisplay();
                }
            });

            return div;
        }

        function calculateCurrentRisk() {
            const likelihoodEl = document.getElementById('likelihood');
            const impactEl = document.getElementById('impact');
            
            if (!likelihoodEl || !impactEl) {
                console.error('Risk assessment elements not found');
                return;
            }

            const likelihood = parseInt(likelihoodEl.value);
            const impact = parseInt(impactEl.value);
            const riskScore = likelihood * impact;
            
            currentAssessment.currentRisk = {
                likelihood: likelihood,
                impact: impact,
                score: riskScore,
                level: getRiskLevel(riskScore)
            };

            const currentRiskScore = document.getElementById('currentRiskScore');
            const currentRiskLevel = document.getElementById('currentRiskLevel');
            
            if (currentRiskScore) {
                currentRiskScore.textContent = `Risk Score: ${riskScore}`;
                currentRiskScore.className = `risk-score ${getRiskClass(riskScore)}`;
            }
            
            if (currentRiskLevel) {
                currentRiskLevel.textContent = currentAssessment.currentRisk.level;
            }

            // Update comparison table
            updateComparisonTable();
            // Update the detailed risk table
            updateRiskTable();
        }

        function updateComparisonTable() {
            const beforeLikelihood = document.getElementById('beforeLikelihood');
            const beforeImpact = document.getElementById('beforeImpact');
            const beforeScore = document.getElementById('beforeScore');
            const beforeLevel = document.getElementById('beforeLevel');

            if (currentAssessment.currentRisk && currentAssessment.currentRisk.likelihood) {
                if (beforeLikelihood) beforeLikelihood.textContent = currentAssessment.currentRisk.likelihood;
                if (beforeImpact) beforeImpact.textContent = currentAssessment.currentRisk.impact;
                if (beforeScore) beforeScore.textContent = currentAssessment.currentRisk.score;
                if (beforeLevel) beforeLevel.textContent = currentAssessment.currentRisk.level;
                
                // Update visual risk matrix
                updateVisualRiskMatrix();
            }
        }

        function updateVisualRiskMatrix() {
            // Clear existing markers
            document.querySelectorAll('.risk-position, .risk-arrow').forEach(el => el.remove());
            document.querySelectorAll('.matrix-cell').forEach(el => {
                el.classList.remove('current-before', 'current-after', 'has-movement');
            });

            // Add BEFORE position if current risk exists
            if (currentAssessment.currentRisk && currentAssessment.currentRisk.likelihood) {
                addRiskPosition(
                    currentAssessment.currentRisk.likelihood, 
                    currentAssessment.currentRisk.impact, 
                    'before'
                );
            }

            // Add AFTER position if adjusted risk exists
            if (currentAssessment.adjustedRisk && currentAssessment.adjustedRisk.likelihood) {
                addRiskPosition(
                    currentAssessment.adjustedRisk.likelihood, 
                    currentAssessment.adjustedRisk.impact, 
                    'after'
                );

                // Add arrow showing movement if positions are different
                if (currentAssessment.currentRisk && 
                    (currentAssessment.currentRisk.likelihood !== currentAssessment.adjustedRisk.likelihood ||
                     currentAssessment.currentRisk.impact !== currentAssessment.adjustedRisk.impact)) {
                    addRiskMovementArrow();
                }
            }
        }

        function addRiskPosition(likelihood, impact, type) {
            // Find the correct cell based on likelihood and impact
            const cell = document.querySelector(
                `.matrix-cell[data-likelihood="${likelihood}"][data-impact="${impact}"]`
            );
            
            if (cell) {
                // Add highlighting to the cell
                cell.classList.add(`current-${type}`);
                
                // Create position marker
                const marker = document.createElement('div');
                marker.className = `risk-position ${type}`;
                marker.textContent = type === 'before' ? 'B' : 'A';
                marker.title = type === 'before' ? 'BEFORE Controls' : 'AFTER Controls';
                
                cell.appendChild(marker);
            }
        }

        function addRiskMovementArrow() {
            // Find cells with both before and after positions
            const beforeCell = document.querySelector('.matrix-cell.current-before');
            const afterCell = document.querySelector('.matrix-cell.current-after');
            
            if (beforeCell && afterCell && beforeCell !== afterCell) {
                // Add movement animation
                beforeCell.classList.add('has-movement');
                afterCell.classList.add('has-movement');
                
                // Add arrow to the "after" cell if different from "before"
                const arrow = document.createElement('div');
                arrow.className = 'risk-arrow';
                arrow.innerHTML = '‚Üí';
                arrow.title = 'Risk moved from BEFORE to AFTER position';
                
                afterCell.appendChild(arrow);
            }
        }

        function updateRiskTable() {
            // Safely get elements and check if they exist
            const riskDescription = document.getElementById('riskDescription');
            const inherentEvaluation = document.getElementById('inherentEvaluation');
            const controlsList = document.getElementById('controlsList');
            const residualEvaluation = document.getElementById('residualEvaluation');

            // Update risk description
            const findingTitle = document.getElementById('findingTitle')?.value || 'Security Finding';
            const findingDescription = document.getElementById('findingDescription')?.value || 'Security risk assessment';
            const assetName = document.getElementById('assetName')?.value || 'Asset';
            
            if (riskDescription) {
                riskDescription.innerHTML = `
                    <strong>Risk of ${findingTitle.toLowerCase()}</strong><br>
                    <span style="font-size: 0.9em; color: #666;">${findingDescription.substring(0, 100)}${findingDescription.length > 100 ? '...' : ''}</span><br>
                    <small style="color: #999;">Asset: ${assetName}</small>
                `;
            }

            // Update inherent evaluation
            if (inherentEvaluation && currentAssessment.currentRisk && currentAssessment.currentRisk.likelihood) {
                const likelihoodText = getLikelihoodText(currentAssessment.currentRisk.likelihood);
                const impactText = getImpactText(currentAssessment.currentRisk.impact);
                const riskLevel = currentAssessment.currentRisk.level;
                const riskColor = getRiskTableColor(currentAssessment.currentRisk.score);

                inherentEvaluation.innerHTML = `
                    <div style="background: ${riskColor}; padding: 15px; border-radius: 8px; color: white; font-weight: bold;">
                        ${likelihoodText}<br>x ${impactText}<br>= ${riskLevel}
                    </div>
                `;
            }

            // Update control measures
            updateControlMeasuresDisplay();

            // Update residual evaluation if calculated
            if (residualEvaluation && currentAssessment.adjustedRisk && currentAssessment.adjustedRisk.likelihood) {
                const likelihoodText = getLikelihoodText(currentAssessment.adjustedRisk.likelihood);
                const impactText = getImpactText(currentAssessment.adjustedRisk.impact);
                const riskLevel = currentAssessment.adjustedRisk.level;
                const riskColor = getRiskTableColor(currentAssessment.adjustedRisk.score);

                residualEvaluation.innerHTML = `
                    <div style="background: ${riskColor}; padding: 15px; border-radius: 8px; color: white; font-weight: bold;">
                        ${likelihoodText}<br>x ${impactText}<br>= ${riskLevel}
                    </div>
                `;
            } else if (residualEvaluation) {
                residualEvaluation.innerHTML = `
                    <div style="background: #95a5a6; padding: 15px; border-radius: 8px; color: white; font-weight: bold;">
                        Not calculated
                    </div>
                `;
            }
        }

        function getLikelihoodText(likelihood) {
            const likelihoodMap = {
                5: 'Almost Certain',
                4: 'Likely', 
                3: 'Possible',
                2: 'Unlikely',
                1: 'Rare'
            };
            return likelihoodMap[likelihood] || 'Unknown';
        }

        function getImpactText(impact) {
            const impactMap = {
                5: 'Extreme',
                4: 'Major',
                3: 'Moderate', 
                2: 'Minor',
                1: 'Insignificant'
            };
            return impactMap[impact] || 'Unknown';
        }

        function getRiskTableColor(score) {
            if (score >= 20) return '#c0392b';  // Very High - Dark Red
            if (score >= 15) return '#e74c3c';  // High - Red
            if (score >= 10) return '#f39c12';  // Medium - Orange
            if (score >= 5) return '#f1c40f';   // Low - Yellow
            return '#27ae60';                    // Very Low - Green
        }

        function updateControlMeasuresDisplay() {
            const selectedCheckboxes = document.querySelectorAll('.control-item input[type="checkbox"]:checked');
            const controlsList = document.getElementById('controlsList');
            
            if (!controlsList) return;
            
            if (selectedCheckboxes.length === 0) {
                controlsList.innerHTML = '<em style="color: #666;">No compensating controls applied yet</em>';
                return;
            }

            const controls = [];
            selectedCheckboxes.forEach(checkbox => {
                const controlId = checkbox.id;
                const control = [...defaultControls.preventative, ...defaultControls.mitigative]
                    .find(c => c.id === controlId);
                if (control) {
                    controls.push(`<strong>${control.id}:</strong> ${control.name}`);
                }
            });

            controlsList.innerHTML = `
                <ul style="margin: 0; padding-left: 20px;">
                    ${controls.map(control => `<li style="margin-bottom: 8px;">${control}</li>`).join('')}
                </ul>
            `;
        }

        function getRiskLevel(score) {
            if (score >= 20) return 'Very High Risk';
            if (score >= 15) return 'High Risk';
            if (score >= 10) return 'Medium Risk';
            if (score >= 5) return 'Low Risk';
            return 'Very Low Risk';
        }

        function getRiskClass(score) {
            if (score >= 20) return 'risk-very-high';
            if (score >= 15) return 'risk-high';
            if (score >= 10) return 'risk-medium';
            if (score >= 5) return 'risk-low';
            return 'risk-very-low';
        }

        function applyCompensatingControls() {
            // Collect selected controls
            const selectedCheckboxes = document.querySelectorAll('.control-item input[type="checkbox"]:checked');
            currentAssessment.selectedControls = [];

            let totalLikelihoodReduction = 0;
            let totalImpactReduction = 0;

            selectedCheckboxes.forEach(checkbox => {
                const controlId = checkbox.id;
                const controlType = checkbox.dataset.type;
                const control = [...defaultControls.preventative, ...defaultControls.mitigative]
                    .find(c => c.id === controlId);
                
                if (control) {
                    currentAssessment.selectedControls.push(control);
                    totalLikelihoodReduction += control.riskReduction.likelihood;
                    totalImpactReduction += control.riskReduction.impact;
                }
            });

            // Calculate adjusted risk with diminishing returns
            const likelihoodMultiplier = Math.max(0.1, 1 - Math.min(0.8, totalLikelihoodReduction));
            const impactMultiplier = Math.max(0.1, 1 - Math.min(0.8, totalImpactReduction));

            const adjustedLikelihood = Math.max(1, Math.round(currentAssessment.currentRisk.likelihood * likelihoodMultiplier));
            const adjustedImpact = Math.max(1, Math.round(currentAssessment.currentRisk.impact * impactMultiplier));
            const adjustedScore = adjustedLikelihood * adjustedImpact;

            currentAssessment.adjustedRisk = {
                likelihood: adjustedLikelihood,
                impact: adjustedImpact,
                score: adjustedScore,
                level: getRiskLevel(adjustedScore)
            };

            // Update after controls in comparison table
            const afterLikelihood = document.getElementById('afterLikelihood');
            const afterImpact = document.getElementById('afterImpact');
            const afterScore = document.getElementById('afterScore');
            const afterLevel = document.getElementById('afterLevel');

            if (afterLikelihood) afterLikelihood.textContent = adjustedLikelihood;
            if (afterImpact) afterImpact.textContent = adjustedImpact;
            if (afterScore) afterScore.textContent = adjustedScore;
            if (afterLevel) afterLevel.textContent = currentAssessment.adjustedRisk.level;

            // Update the detailed risk table
            updateRiskTable();

            // Update the visual risk matrix
            updateVisualRiskMatrix();

            // Perform gap analysis
            performGapAnalysis();
            generateOFIs();
        }

        function performGapAnalysis() {
            const gapAnalysis = document.getElementById('gapAnalysis');
            const gapContent = document.getElementById('gapContent');
            
            if (!gapAnalysis || !gapContent) return;
            
            let gaps = [];

            // Check if risk is still high after controls
            if (currentAssessment.adjustedRisk.score >= 15) {
                gaps.push('Risk remains HIGH even after applying compensating controls. Additional controls may be required.');
            }

            // Check for missing control categories
            const selectedTypes = new Set(currentAssessment.selectedControls.map(c => {
                return [...defaultControls.preventative, ...defaultControls.mitigative]
                    .find(dc => dc.id === c.id) ? 
                    (defaultControls.preventative.find(dc => dc.id === c.id) ? 'preventative' : 'mitigative') : null;
            }));

            if (!selectedTypes.has('preventative')) {
                gaps.push('No preventative controls selected. Consider implementing ID.AM, PR.AC, or PR.PT controls.');
            }

            if (!selectedTypes.has('mitigative')) {
                gaps.push('No mitigative/reactive controls selected. Consider implementing DE.AE, RS.RP, or RC.RP controls.');
            }

            // Check for specific high-impact gaps
            const hasAccessControl = currentAssessment.selectedControls.some(c => c.id === 'PR.AC');
            const hasMonitoring = currentAssessment.selectedControls.some(c => c.id === 'DE.AE' || c.id === 'DE.CM');
            
            if (!hasAccessControl && currentAssessment.currentRisk.impact >= 4) {
                gaps.push('High-impact finding lacks Identity & Access Control (PR.AC) - critical gap for this threat type.');
            }

            if (!hasMonitoring && currentAssessment.currentRisk.likelihood >= 4) {
                gaps.push('High-likelihood finding lacks continuous monitoring (DE.AE/DE.CM) - detection gap identified.');
            }

            currentAssessment.gaps = gaps;

            if (gaps.length > 0) {
                gapContent.innerHTML = gaps.map(gap => `<p>‚ö†Ô∏è ${gap}</p>`).join('');
                gapAnalysis.classList.remove('hidden');
            } else {
                gapAnalysis.classList.add('hidden');
            }
        }

        function generateOFIs() {
            const ofiSection = document.getElementById('ofiSection');
            const ofiContent = document.getElementById('ofiContent');
            
            if (!ofiSection || !ofiContent) return;
            
            let ofis = [];

            // Risk reduction opportunities
            const riskReduction = currentAssessment.currentRisk.score - currentAssessment.adjustedRisk.score;
            if (riskReduction > 0) {
                ofis.push(`Implemented controls achieved ${Math.round((riskReduction / currentAssessment.currentRisk.score) * 100)}% risk reduction. Consider standardizing these controls across similar assets.`);
            }

            // Suggest additional controls based on remaining risk
            if (currentAssessment.adjustedRisk.score >= 10) {
                const missingControls = [...defaultControls.preventative, ...defaultControls.mitigative]
                    .filter(c => !currentAssessment.selectedControls.some(sc => sc.id === c.id))
                    .sort((a, b) => (b.riskReduction.likelihood + b.riskReduction.impact) - (a.riskReduction.likelihood + a.riskReduction.impact))
                    .slice(0, 3);

                if (missingControls.length > 0) {
                    ofis.push(`Consider implementing these high-impact controls: ${missingControls.map(c => c.id + ' (' + c.name + ')').join(', ')}`);
                }
            }

            // Asset-specific recommendations
            const confidentialityEl = document.getElementById('confidentiality');
            const integrityEl = document.getElementById('integrity');
            const availabilityEl = document.getElementById('availability');

            if (confidentialityEl && integrityEl && availabilityEl) {
                const confidentiality = parseInt(confidentialityEl.value);
                const integrity = parseInt(integrityEl.value);
                const availability = parseInt(availabilityEl.value);

                if (confidentiality >= 4 && !currentAssessment.selectedControls.some(c => c.id === 'PR.DS')) {
                    ofis.push('High confidentiality asset should implement enhanced Data Security (PR.DS) controls.');
                }

                if (availability >= 4 && !currentAssessment.selectedControls.some(c => c.id === 'RC.RP')) {
                    ofis.push('High availability asset requires robust Recovery Planning (RC.RP) capabilities.');
                }
            }

            // Control maturity recommendations
            if (currentAssessment.selectedControls.length < 3) {
                ofis.push('Limited compensating controls identified. Consider expanding control coverage across preventative and reactive categories.');
            }

            currentAssessment.ofis = ofis;

            if (ofis.length > 0) {
                ofiContent.innerHTML = ofis.map(ofi => `<p>üí° ${ofi}</p>`).join('');
                ofiSection.classList.remove('hidden');
            } else {
                ofiSection.classList.add('hidden');
            }
        }

        function loadCustomConfiguration(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const customConfig = JSON.parse(e.target.result);
                    
                    // Update bow tie visualization with custom data
                    if (customConfig.threats) {
                        const threatsContent = document.getElementById('threatsContent');
                        if (threatsContent) {
                            threatsContent.innerHTML = formatConfigContent(customConfig.threats);
                        }
                    }
                    if (customConfig.preventativeControls) {
                        const preventativeContent = document.getElementById('preventativeContent');
                        if (preventativeContent) {
                            preventativeContent.innerHTML = formatConfigContent(customConfig.preventativeControls);
                        }
                    }
                    if (customConfig.incidents) {
                        const incidentContent = document.getElementById('incidentContent');
                        if (incidentContent) {
                            incidentContent.innerHTML = formatConfigContent(customConfig.incidents);
                        }
                    }
                    if (customConfig.mitigativeControls) {
                        const mitigativeContent = document.getElementById('mitigativeContent');
                        if (mitigativeContent) {
                            mitigativeContent.innerHTML = formatConfigContent(customConfig.mitigativeControls);
                        }
                    }
                    if (customConfig.consequences) {
                        const consequencesContent = document.getElementById('consequencesContent');
                        if (consequencesContent) {
                            consequencesContent.innerHTML = formatConfigContent(customConfig.consequences);
                        }
                    }

                    // Update controls if provided
                    if (customConfig.controls) {
                        updateControlsFromConfig(customConfig.controls);
                    }

                    alert('‚úÖ Custom configuration loaded successfully!');
                } catch (error) {
                    alert('‚ùå Error parsing JSON file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function formatConfigContent(items) {
            if (Array.isArray(items)) {
                return items.map(item => `‚Ä¢ ${item}`).join('<br>');
            } else if (typeof items === 'object') {
                return Object.entries(items).map(([key, value]) => `<strong>${key}:</strong> ${value}`).join('<br>');
            }
            return items.toString();
        }

        function updateControlsFromConfig(customControls) {
            const preventativeGrid = document.getElementById('preventativeControlsGrid');
            const reactiveGrid = document.getElementById('reactiveControlsGrid');
            
            if (!preventativeGrid || !reactiveGrid) return;

            // Clear existing content
            preventativeGrid.innerHTML = '';
            reactiveGrid.innerHTML = '';

            // Add preventative controls
            if (customControls.preventative) {
                customControls.preventative.forEach(control => {
                    const controlObj = {
                        id: control.id || `CUSTOM_${Math.random().toString(36).substr(2, 9)}`,
                        name: control.name || 'Custom Control',
                        description: control.description || 'Custom control description',
                        riskReduction: control.riskReduction || { likelihood: 0.3, impact: 0.3 }
                    };
                    
                    const controlElement = createControlElement(controlObj, 'preventative');
                    preventativeGrid.appendChild(controlElement);
                });
            }

            // Add reactive/mitigative controls
            if (customControls.mitigative) {
                customControls.mitigative.forEach(control => {
                    const controlObj = {
                        id: control.id || `CUSTOM_${Math.random().toString(36).substr(2, 9)}`,
                        name: control.name || 'Custom Control',
                        description: control.description || 'Custom control description',
                        riskReduction: control.riskReduction || { likelihood: 0.3, impact: 0.3 }
                    };
                    
                    const controlElement = createControlElement(controlObj, 'mitigative');
                    reactiveGrid.appendChild(controlElement);
                });
            }
        }

        function exportAssessment() {
            // Collect all assessment data
            const assessmentData = {
                finding: {
                    title: document.getElementById('findingTitle')?.value || '',
                    description: document.getElementById('findingDescription')?.value || '',
                    asset: document.getElementById('assetName')?.value || '',
                    cia: {
                        confidentiality: document.getElementById('confidentiality')?.value || '3',
                        integrity: document.getElementById('integrity')?.value || '3',
                        availability: document.getElementById('availability')?.value || '3'
                    }
                },
                riskAssessment: {
                    current: currentAssessment.currentRisk,
                    adjusted: currentAssessment.adjustedRisk,
                    selectedControls: currentAssessment.selectedControls
                },
                analysis: {
                    gaps: currentAssessment.gaps,
                    ofis: currentAssessment.ofis,
                    notes: document.getElementById('assessmentNotes')?.value || ''
                },
                metadata: {
                    assessmentDate: new Date().toISOString(),
                    tool: 'Bow Tie Risk Assessment Tool v1.0'
                }
            };

            // Create downloadable report
            const reportContent = generateReport(assessmentData);
            const blob = new Blob([reportContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `bow_tie_assessment_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Also generate human-readable report
            generateHumanReadableReport(assessmentData);
        }

        function generateReport(data) {
            return JSON.stringify(data, null, 2);
        }

        function generateHumanReadableReport(data) {
            const report = `
# Bow Tie Risk Assessment Report

## Finding Details
**Title:** ${data.finding.title}
**Asset:** ${data.finding.asset}
**Description:** ${data.finding.description}

## Asset Classification (CIA)
- **Confidentiality:** ${data.finding.cia.confidentiality}/5
- **Integrity:** ${data.finding.cia.integrity}/5
- **Availability:** ${data.finding.cia.availability}/5

## Risk Assessment
### Current Risk (Before Controls)
- **Likelihood:** ${data.riskAssessment.current?.likelihood || 'N/A'}/5
- **Impact:** ${data.riskAssessment.current?.impact || 'N/A'}/5
- **Risk Score:** ${data.riskAssessment.current?.score || 'N/A'}
- **Risk Level:** ${data.riskAssessment.current?.level || 'N/A'}

### Adjusted Risk (After Controls)
- **Likelihood:** ${data.riskAssessment.adjusted?.likelihood || 'N/A'}/5
- **Impact:** ${data.riskAssessment.adjusted?.impact || 'N/A'}/5
- **Risk Score:** ${data.riskAssessment.adjusted?.score || 'N/A'}
- **Risk Level:** ${data.riskAssessment.adjusted?.level || 'N/A'}

## Applied Compensating Controls
${data.riskAssessment.selectedControls?.length > 0 ? 
    data.riskAssessment.selectedControls.map(c => `- **${c.id}:** ${c.name} - ${c.description}`).join('\n') :
    'No controls applied'
}

## Gap Analysis
${data.analysis.gaps?.length > 0 ? data.analysis.gaps.map(gap => `- ${gap}`).join('\n') : 'No significant gaps identified.'}

## Opportunities for Improvement
${data.analysis.ofis?.length > 0 ? data.analysis.ofis.map(ofi => `- ${ofi}`).join('\n') : 'No specific opportunities identified.'}

## Additional Notes
${data.analysis.notes || 'No additional notes provided.'}

---
*Report generated on ${new Date().toLocaleDateString()} using Bow Tie Risk Assessment Tool*
            `;

            const blob = new Blob([report], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `bow_tie_assessment_report_${new Date().toISOString().split('T')[0]}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('üìÑ Assessment exported successfully! Both JSON data and markdown report have been downloaded.');
        }

        function saveSession() {
            const sessionData = {
                finding: {
                    title: document.getElementById('findingTitle')?.value || '',
                    description: document.getElementById('findingDescription')?.value || '',
                    asset: document.getElementById('assetName')?.value || '',
                    cia: {
                        confidentiality: document.getElementById('confidentiality')?.value || '3',
                        integrity: document.getElementById('integrity')?.value || '3',
                        availability: document.getElementById('availability')?.value || '3'
                    }
                },
                risk: {
                    likelihood: document.getElementById('likelihood')?.value || '3',
                    impact: document.getElementById('impact')?.value || '4'
                },
                selectedControls: Array.from(document.querySelectorAll('.control-item input[type="checkbox"]:checked')).map(cb => cb.id),
                notes: document.getElementById('assessmentNotes')?.value || '',
                timestamp: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(sessionData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `bow_tie_session_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('üíæ Session saved successfully!');
        }

        function loadSession() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const sessionData = JSON.parse(e.target.result);
                        
                        // Restore form values safely
                        const findingTitle = document.getElementById('findingTitle');
                        const findingDescription = document.getElementById('findingDescription');
                        const assetName = document.getElementById('assetName');
                        const confidentiality = document.getElementById('confidentiality');
                        const integrity = document.getElementById('integrity');
                        const availability = document.getElementById('availability');
                        const likelihood = document.getElementById('likelihood');
                        const impact = document.getElementById('impact');
                        const assessmentNotes = document.getElementById('assessmentNotes');

                        if (findingTitle) findingTitle.value = sessionData.finding.title || '';
                        if (findingDescription) findingDescription.value = sessionData.finding.description || '';
                        if (assetName) assetName.value = sessionData.finding.asset || '';
                        if (confidentiality) confidentiality.value = sessionData.finding.cia.confidentiality || '3';
                        if (integrity) integrity.value = sessionData.finding.cia.integrity || '3';
                        if (availability) availability.value = sessionData.finding.cia.availability || '3';
                        if (likelihood) likelihood.value = sessionData.risk.likelihood || '3';
                        if (impact) impact.value = sessionData.risk.impact || '4';
                        if (assessmentNotes) assessmentNotes.value = sessionData.notes || '';

                        // Restore selected controls
                        document.querySelectorAll('.control-item input[type="checkbox"]').forEach(cb => {
                            cb.checked = sessionData.selectedControls.includes(cb.id);
                            const controlItem = cb.closest('.control-item');
                            if (controlItem) {
                                controlItem.classList.toggle('selected', cb.checked);
                            }
                        });

                        // Recalculate risk
                        calculateCurrentRisk();

                        alert('üìÇ Session loaded successfully!');
                    } catch (error) {
                        alert('‚ùå Error loading session: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Bow Tie Model Generation Functions
        function generateBowTieModel() {
            const container = document.getElementById('bowTieModelContainer');
            const legend = document.getElementById('modelLegend');
            const exportPngBtn = document.getElementById('exportPngBtn');
            const exportSvgBtn = document.getElementById('exportSvgBtn');
            
            if (container) container.classList.remove('hidden');
            if (legend) legend.classList.remove('hidden');
            if (exportPngBtn) exportPngBtn.style.display = 'inline-block';
            if (exportSvgBtn) exportSvgBtn.style.display = 'inline-block';

            // Generate the SVG bow tie model
            createInteractiveBowTie();
        }

        function createInteractiveBowTie() {
            const svg = document.getElementById('bowTieModel');
            if (!svg) return;

            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                createMobileBowTie(svg);
            } else {
                createDesktopBowTie(svg);
            }
        }

        function createDesktopBowTie(svg) {
            // Clear existing content
            svg.innerHTML = '';

            // Create arrow marker definition
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            marker.setAttribute('id', 'arrowhead');
            marker.setAttribute('markerWidth', '10');
            marker.setAttribute('markerHeight', '7');
            marker.setAttribute('refX', '9');
            marker.setAttribute('refY', '3.5');
            marker.setAttribute('orient', 'auto');
            
            const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            polygon.setAttribute('points', '0 0, 10 3.5, 0 7');
            polygon.setAttribute('fill', '#34495e');
            
            marker.appendChild(polygon);
            defs.appendChild(marker);
            svg.appendChild(defs);

            // Get actual user data
            const findingTitle = document.getElementById('findingTitle')?.value || 'Security Finding';
            const assetName = document.getElementById('assetName')?.value || 'Asset';

            // Central event (red circle) - use actual finding data
            const eventCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            eventCircle.setAttribute('cx', '600');
            eventCircle.setAttribute('cy', '300');
            eventCircle.setAttribute('r', '40');
            eventCircle.setAttribute('class', 'bow-tie-event');
            svg.appendChild(eventCircle);

            const eventText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            eventText.setAttribute('x', '600');
            eventText.setAttribute('y', '300');
            eventText.setAttribute('class', 'bow-tie-text');
            eventText.setAttribute('font-size', '10');
            // Split text if too long
            const eventTextContent = findingTitle.length > 20 ? findingTitle.substring(0, 17) + '...' : findingTitle;
            eventText.textContent = eventTextContent;
            svg.appendChild(eventText);

            // Hazard (yellow diamond above event) - use asset name
            createDiamond(svg, 600, 200, 50, 30, 'bow-tie-event', assetName.length > 15 ? assetName.substring(0, 12) + '...' : assetName);

            // Create threats (only External Threat as specified)
            const threatRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            threatRect.setAttribute('x', '50');
            threatRect.setAttribute('y', '275');
            threatRect.setAttribute('width', '120');
            threatRect.setAttribute('height', '50');
            threatRect.setAttribute('rx', '8');
            threatRect.setAttribute('class', 'bow-tie-threat');
            svg.appendChild(threatRect);

            const threatText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            threatText.setAttribute('x', '110');
            threatText.setAttribute('y', '305');
            threatText.setAttribute('class', 'bow-tie-text');
            threatText.textContent = 'External Threat';
            svg.appendChild(threatText);

            // Draw path from threat to event
            const threatPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            threatPath.setAttribute('d', 'M 170 300 L 560 300');
            threatPath.setAttribute('stroke', '#34495e');
            threatPath.setAttribute('stroke-width', '2');
            threatPath.setAttribute('fill', 'none');
            svg.appendChild(threatPath);

            // Create consequences based on CIA impact
            const consequences = getActualConsequences();
            consequences.forEach((consequence, index) => {
                const yPos = 200 + (index * 80);
                
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', '1030');
                rect.setAttribute('y', yPos - 25);
                rect.setAttribute('width', '120');
                rect.setAttribute('height', '50');
                rect.setAttribute('rx', '8');
                rect.setAttribute('class', 'bow-tie-consequence');
                svg.appendChild(rect);

                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', '1090');
                text.setAttribute('y', yPos + 5);
                text.setAttribute('class', 'bow-tie-text');
                text.setAttribute('font-size', '10');
                consequence.split('\n').forEach((line, lineIndex) => {
                    const tspan = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
                    tspan.setAttribute('x', '1090');
                    tspan.setAttribute('dy', lineIndex === 0 ? '-5' : '12');
                    tspan.textContent = line;
                    text.appendChild(tspan);
                });
                svg.appendChild(text);

                // Draw path from event to consequence
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M 640 300 L 1030 ${yPos}`);
                path.setAttribute('stroke', '#34495e');
                path.setAttribute('stroke-width', '2');
                path.setAttribute('fill', 'none');
                svg.appendChild(path);
            });

            // Add only SELECTED preventative controls
            addActualPreventativeControls(svg);
            
            // Add only SELECTED reactive controls
            addActualReactiveControls(svg);

            // Add logical flow arrow
            const flowArrow = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            flowArrow.setAttribute('d', 'M 100 550 L 1100 550');
            flowArrow.setAttribute('class', 'logical-flow-arrow');
            svg.appendChild(flowArrow);

            const flowText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            flowText.setAttribute('x', '600');
            flowText.setAttribute('y', '540');
            flowText.setAttribute('class', 'bow-tie-small-text');
            flowText.setAttribute('text-anchor', 'middle');
            flowText.textContent = 'Logical Flow (can the potential cause create the Event and does that create the Consequence)';
            svg.appendChild(flowText);

            // Add tooltips
            addTooltipSupport();
        }

        function getActualConsequences() {
            const confidentialityEl = document.getElementById('confidentiality');
            const integrityEl = document.getElementById('integrity');
            const availabilityEl = document.getElementById('availability');

            const confidentiality = confidentialityEl ? parseInt(confidentialityEl.value) : 3;
            const integrity = integrityEl ? parseInt(integrityEl.value) : 3;
            const availability = availabilityEl ? parseInt(availabilityEl.value) : 3;

            const consequences = [];

            // Add consequences based on CIA scores
            if (confidentiality >= 4) {
                consequences.push('Data\nBreach');
            }
            if (integrity >= 4) {
                consequences.push('Data\nCorruption');
            }
            if (availability >= 4) {
                consequences.push('Service\nDisruption');
            }

            // Add generic consequences if CIA scores are lower
            if (consequences.length === 0) {
                if (confidentiality >= 3) consequences.push('Info\nDisclosure');
                if (integrity >= 3) consequences.push('Data\nModification');
                if (availability >= 3) consequences.push('System\nDowntime');
            }

            // Ensure at least one consequence
            if (consequences.length === 0) {
                consequences.push('Security\nImpact');
            }

            return consequences;
        }

        function addActualPreventativeControls(svg) {
            // Get only SELECTED preventative controls
            const selectedCheckboxes = document.querySelectorAll('.control-item input[type="checkbox"]:checked');
            const selectedPreventativeControls = [];

            selectedCheckboxes.forEach(checkbox => {
                const controlId = checkbox.id;
                const control = defaultControls.preventative.find(c => c.id === controlId);
                if (control) {
                    selectedPreventativeControls.push(control);
                }
            });

            // If no controls selected, show message
            if (selectedPreventativeControls.length === 0) {
                const noControlsText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                noControlsText.setAttribute('x', '300');
                noControlsText.setAttribute('y', '400');
                noControlsText.setAttribute('class', 'bow-tie-small-text');
                noControlsText.setAttribute('fill', '#666');
                noControlsText.textContent = 'No preventative controls selected';
                svg.appendChild(noControlsText);
                return;
            }

            selectedPreventativeControls.forEach((control, index) => {
                const yPos = 250 + (index * 60);
                const xPos = 300;

                // Control barrier
                const effectiveness = getControlEffectiveness(control);
                const barrierHeight = Math.max(20, effectiveness * 60);
                
                const barrier = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                barrier.setAttribute('x', xPos - 3);
                barrier.setAttribute('y', yPos - barrierHeight/2);
                barrier.setAttribute('width', '6');
                barrier.setAttribute('height', barrierHeight);
                barrier.setAttribute('class', `control-barrier ${getEffectivenessClass(effectiveness)} selected`);
                barrier.setAttribute('data-control-id', control.id);
                barrier.setAttribute('data-type', 'preventative');
                svg.appendChild(barrier);

                // Control box
                const controlRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                controlRect.setAttribute('x', xPos + 10);
                controlRect.setAttribute('y', yPos - 15);
                controlRect.setAttribute('width', '80');
                controlRect.setAttribute('height', '30');
                controlRect.setAttribute('rx', '4');
                controlRect.setAttribute('class', 'bow-tie-preventative selected');
                controlRect.setAttribute('data-control-id', control.id);
                controlRect.setAttribute('data-type', 'preventative');
                svg.appendChild(controlRect);

                const controlText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                controlText.setAttribute('x', xPos + 50);
                controlText.setAttribute('y', yPos + 5);
                controlText.setAttribute('class', 'bow-tie-text');
                controlText.setAttribute('font-size', '10');
                controlText.textContent = control.id;
                svg.appendChild(controlText);

                // Add click handler
                controlRect.addEventListener('click', () => toggleControl(control.id, 'preventative'));
                barrier.addEventListener('click', () => toggleControl(control.id, 'preventative'));

                // Add hover tooltip
                addControlTooltip(controlRect, control);
                addControlTooltip(barrier, control);
            });
        }

        function addActualReactiveControls(svg) {
            // Get only SELECTED reactive/mitigative controls
            const selectedCheckboxes = document.querySelectorAll('.control-item input[type="checkbox"]:checked');
            const selectedReactiveControls = [];

            selectedCheckboxes.forEach(checkbox => {
                const controlId = checkbox.id;
                const control = defaultControls.mitigative.find(c => c.id === controlId);
                if (control) {
                    selectedReactiveControls.push(control);
                }
            });

            // If no controls selected, show message
            if (selectedReactiveControls.length === 0) {
                const noControlsText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                noControlsText.setAttribute('x', '900');
                noControlsText.setAttribute('y', '400');
                noControlsText.setAttribute('class', 'bow-tie-small-text');
                noControlsText.setAttribute('fill', '#666');
                noControlsText.textContent = 'No reactive controls selected';
                svg.appendChild(noControlsText);
                return;
            }

            selectedReactiveControls.forEach((control, index) => {
                const yPos = 250 + (index * 60);
                const xPos = 900;

                // Control barrier
                const effectiveness = getControlEffectiveness(control);
                const barrierHeight = Math.max(20, effectiveness * 60);
                
                const barrier = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                barrier.setAttribute('x', xPos - 3);
                barrier.setAttribute('y', yPos - barrierHeight/2);
                barrier.setAttribute('width', '6');
                barrier.setAttribute('height', barrierHeight);
                barrier.setAttribute('class', `control-barrier ${getEffectivenessClass(effectiveness)} selected`);
                barrier.setAttribute('data-control-id', control.id);
                barrier.setAttribute('data-type', 'mitigative');
                svg.appendChild(barrier);

                // Control box
                const controlRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                controlRect.setAttribute('x', xPos + 10);
                controlRect.setAttribute('y', yPos - 15);
                controlRect.setAttribute('width', '80');
                controlRect.setAttribute('height', '30');
                controlRect.setAttribute('rx', '4');
                controlRect.setAttribute('class', 'bow-tie-reactive selected');
                controlRect.setAttribute('data-control-id', control.id);
                controlRect.setAttribute('data-type', 'mitigative');
                svg.appendChild(controlRect);

                const controlText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                controlText.setAttribute('x', xPos + 50);
                controlText.setAttribute('y', yPos + 5);
                controlText.setAttribute('class', 'bow-tie-text');
                controlText.setAttribute('font-size', '10');
                controlText.textContent = control.id;
                svg.appendChild(controlText);

                // Add click handler
                controlRect.addEventListener('click', () => toggleControl(control.id, 'mitigative'));
                barrier.addEventListener('click', () => toggleControl(control.id, 'mitigative'));

                // Add hover tooltip
                addControlTooltip(controlRect, control);
                addControlTooltip(barrier, control);
            });
        }

        function createMobileBowTie(svg) {
            // Simplified mobile version - vertical layout
            svg.innerHTML = '';
            svg.setAttribute('viewBox', '0 0 400 800');

            // Create a simplified vertical flow for mobile
            let yPos = 50;

            // Threats section
            const threatsTitle = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            threatsTitle.setAttribute('x', '200');
            threatsTitle.setAttribute('y', yPos);
            threatsTitle.setAttribute('class', 'bow-tie-text');
            threatsTitle.setAttribute('fill', '#333');
            threatsTitle.textContent = 'Threats';
            svg.appendChild(threatsTitle);

            yPos += 40;
            const threatRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            threatRect.setAttribute('x', '100');
            threatRect.setAttribute('y', yPos);
            threatRect.setAttribute('width', '200');
            threatRect.setAttribute('height', '60');
            threatRect.setAttribute('rx', '8');
            threatRect.setAttribute('class', 'bow-tie-threat');
            svg.appendChild(threatRect);

            const threatText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            threatText.setAttribute('x', '200');
            threatText.setAttribute('y', yPos + 35);
            threatText.setAttribute('class', 'bow-tie-text');
            threatText.textContent = 'External APT';
            svg.appendChild(threatText);

            // Continue with simplified mobile layout...
            // (This is a simplified version - full implementation would include all elements)
        }

        function createDiamond(svg, cx, cy, width, height, className, text) {
            const diamond = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            const points = `${cx},${cy-height} ${cx+width},${cy} ${cx},${cy+height} ${cx-width},${cy}`;
            diamond.setAttribute('points', points);
            diamond.setAttribute('class', className);
            svg.appendChild(diamond);

            const diamondText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            diamondText.setAttribute('x', cx);
            diamondText.setAttribute('y', cy + 5);
            diamondText.setAttribute('class', 'bow-tie-text');
            diamondText.textContent = text;
            svg.appendChild(diamondText);
        }

        function getControlEffectiveness(control) {
            return (control.riskReduction.likelihood + control.riskReduction.impact) / 2;
        }

        function getEffectivenessClass(effectiveness) {
            if (effectiveness >= 0.6) return 'high-effectiveness';
            if (effectiveness >= 0.4) return 'medium-effectiveness';
            return 'low-effectiveness';
        }

        function toggleControl(controlId, type) {
            const checkbox = document.getElementById(controlId);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                const controlItem = checkbox.closest('.control-item');
                if (controlItem) {
                    controlItem.classList.toggle('selected', checkbox.checked);
                }
                
                // Update control measures display
                updateControlMeasuresDisplay();
                
                // Regenerate the bow tie model to reflect changes
                createInteractiveBowTie();
                
                // Recalculate risk if controls were applied
                if (currentAssessment.adjustedRisk.score) {
                    applyCompensatingControls();
                }
            }
        }

        function addControlTooltip(element, control) {
            element.addEventListener('mouseenter', function(e) {
                showTooltip(e, control);
            });
            
            element.addEventListener('mouseleave', function() {
                hideTooltip();
            });
        }

        function showTooltip(event, control) {
            const effectiveness = getControlEffectiveness(control);
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.innerHTML = `
                <strong>${control.id}: ${control.name}</strong><br>
                ${control.description}<br>
                <em>Risk Reduction: Likelihood(-${Math.round(control.riskReduction.likelihood * 100)}%) Impact(-${Math.round(control.riskReduction.impact * 100)}%)</em><br>
                <em>Effectiveness: ${Math.round(effectiveness * 100)}%</em>
            `;
            
            document.body.appendChild(tooltip);
            
            const rect = event.target.getBoundingClientRect();
            tooltip.style.left = (rect.right + 10) + 'px';
            tooltip.style.top = (rect.top + window.scrollY) + 'px';
            tooltip.style.opacity = '1';
            
            window.currentTooltip = tooltip;
        }

        function hideTooltip() {
            if (window.currentTooltip) {
                window.currentTooltip.remove();
                window.currentTooltip = null;
            }
        }

        function addTooltipSupport() {
            // Add global tooltip cleanup on scroll
            window.addEventListener('scroll', hideTooltip);
        }

        function exportBowTieModel(format) {
            const svg = document.getElementById('bowTieModel');
            if (!svg) {
                alert('‚ùå Bow tie model not found. Please generate the model first.');
                return;
            }

            const svgData = new XMLSerializer().serializeToString(svg);
            
            if (format === 'svg') {
                const blob = new Blob([svgData], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `bow_tie_model_${new Date().toISOString().split('T')[0]}.svg`;
                a.click();
                URL.revokeObjectURL(url);
            } else if (format === 'png') {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    
                    canvas.toBlob(function(blob) {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `bow_tie_model_${new Date().toISOString().split('T')[0]}.png`;
                        a.click();
                        URL.revokeObjectURL(url);
                    });
                };
                
                img.src = 'data:image/svg+xml;base64,' + btoa(svgData);
            }
            
            alert(`üì∏ Bow tie model exported as ${format.toUpperCase()} successfully!`);
        }

        // Add resize handler for responsive bow tie
        window.addEventListener('resize', function() {
            const container = document.getElementById('bowTieModelContainer');
            if (container && !container.classList.contains('hidden')) {
                createInteractiveBowTie();
            }
        });
    </script>
</body>
</html>