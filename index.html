<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bow Tie Risk Assessment Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .workflow-section {
            margin-bottom: 40px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border-left: 5px solid #3498db;
        }

        .workflow-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8em;
            font-weight: 400;
        }

        .bow-tie-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .bow-tie-section {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: transform 0.3s ease;
        }

        .bow-tie-section:hover {
            transform: translateY(-5px);
        }

        .threats { background: #ff6b6b; color: white; }
        .preventative { background: #4ecdc4; color: white; }
        .incident { background: #ffe66d; color: #333; }
        .mitigative { background: #95e1d3; color: #333; }
        .consequences { background: #ffa8a8; color: #333; }

        .bow-tie-section h3 {
            font-size: 1.2em;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .bow-tie-section .content {
            font-size: 0.9em;
            line-height: 1.4;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .cia-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .risk-matrix {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .risk-calculation {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .risk-score {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
        }

        .risk-very-high { background: #e74c3c; color: white; }
        .risk-high { background: #f39c12; color: white; }
        .risk-medium { background: #f1c40f; color: #333; }
        .risk-low { background: #2ecc71; color: white; }
        .risk-very-low { background: #27ae60; color: white; }

        .controls-section {
            margin: 30px 0;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .control-item {
            background: white;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-item:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15);
        }

        .control-item.selected {
            border-color: #2ecc71;
            background: #d5f4e6;
        }

        .control-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .comparison-table th, .comparison-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e6ed;
        }

        .comparison-table th {
            background: #34495e;
            color: white;
            font-weight: 600;
        }

        .gap-analysis {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .ofi-section {
            background: #d1ecf1;
            border: 1px solid #a2d2df;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .file-upload {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            background: #f8f9fa;
            border-color: #2980b9;
        }

        .hidden {
            display: none;
        }

        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            margin: 40px 0;
            border-radius: 1px;
        }

        @media (max-width: 768px) {
            .bow-tie-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .cia-grid {
                grid-template-columns: 1fr;
            }
            
            .risk-matrix {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Bow Tie Risk Assessment Tool</h1>
            <p>Identify compensating controls, control gaps, and opportunities for improvement</p>
        </div>

        <div class="main-content">
            <!-- Step 1: Load Scenario -->
            <div class="workflow-section">
                <h2>Step 1: Load Bow Tie Scenario</h2>
                
                <div class="file-upload">
                    <p><strong>üìÅ Custom JSON Configuration (Optional)</strong></p>
                    <p>Upload your custom threats, controls, and consequences configuration</p>
                    <input type="file" id="jsonUpload" accept=".json" style="margin-top: 10px;">
                    <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        Using default NIST CSF 2.0 controls. You can customize by uploading JSON files with your internal capability framework.
                    </p>
                </div>

                <div class="bow-tie-container" id="bowTieVisualization">
                    <div class="bow-tie-section threats">
                        <h3>Threats</h3>
                        <div class="content" id="threatsContent">
                            <strong>External Threat:</strong><br>
                            Advanced Persistent Threat (APT) targeting critical infrastructure through phishing and lateral movement
                        </div>
                    </div>
                    
                    <div class="bow-tie-section preventative">
                        <h3>Preventative Controls</h3>
                        <div class="content" id="preventativeContent">
                            <strong>NIST CSF 2.0:</strong><br>
                            ‚Ä¢ ID.AM - Asset Management<br>
                            ‚Ä¢ PR.AC - Identity & Access Control<br>
                            ‚Ä¢ PR.AT - Awareness & Training<br>
                            ‚Ä¢ PR.DS - Data Security
                        </div>
                    </div>
                    
                    <div class="bow-tie-section incident">
                        <h3>Incident/Security Event</h3>
                        <div class="content" id="incidentContent">
                            <strong>Potential Events:</strong><br>
                            ‚Ä¢ Unauthorized system access<br>
                            ‚Ä¢ Data exfiltration<br>
                            ‚Ä¢ System compromise<br>
                            ‚Ä¢ Service disruption
                        </div>
                    </div>
                    
                    <div class="bow-tie-section mitigative">
                        <h3>Mitigative/Reactive Controls</h3>
                        <div class="content" id="mitigativeContent">
                            <strong>NIST CSF 2.0:</strong><br>
                            ‚Ä¢ DE.AE - Anomalies & Events<br>
                            ‚Ä¢ RS.RP - Response Planning<br>
                            ‚Ä¢ RS.CO - Communications<br>
                            ‚Ä¢ RC.RP - Recovery Planning
                        </div>
                    </div>
                    
                    <div class="bow-tie-section consequences">
                        <h3>Consequences</h3>
                        <div class="content" id="consequencesContent">
                            <strong>Potential Outcomes:</strong><br>
                            ‚Ä¢ Loss of critical assets/resiliency (Availability, Integrity)<br>
                            ‚Ä¢ Data loss/leakage (Confidentiality, Integrity)<br>
                            ‚Ä¢ Regulatory compliance issues<br>
                            ‚Ä¢ Reputational damage
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-divider"></div>

            <!-- Step 2: Load Finding -->
            <div class="workflow-section">
                <h2>Step 2: Load Your Finding</h2>
                
                <div class="form-group">
                    <label for="findingTitle">Finding Title:</label>
                    <input type="text" id="findingTitle" placeholder="e.g., Insufficient Email Security Controls">
                </div>

                <div class="form-group">
                    <label for="findingDescription">Finding Description:</label>
                    <textarea id="findingDescription" rows="4" placeholder="Detailed description of the security finding..."></textarea>
                </div>

                <div class="form-group">
                    <label for="assetName">Asset Name:</label>
                    <input type="text" id="assetName" placeholder="e.g., Email Infrastructure, Customer Database">
                </div>

                <div class="form-group">
                    <label>Asset Criticality & Sensitivity (CIA Scores out of 5):</label>
                    <div class="cia-grid">
                        <div>
                            <label for="confidentiality">Confidentiality:</label>
                            <select id="confidentiality">
                                <option value="1">1 - Public</option>
                                <option value="2">2 - Internal</option>
                                <option value="3" selected>3 - Confidential</option>
                                <option value="4">4 - Restricted</option>
                                <option value="5">5 - Top Secret</option>
                            </select>
                        </div>
                        <div>
                            <label for="integrity">Integrity:</label>
                            <select id="integrity">
                                <option value="1">1 - Minimal</option>
                                <option value="2">2 - Low</option>
                                <option value="3" selected>3 - Moderate</option>
                                <option value="4">4 - High</option>
                                <option value="5">5 - Critical</option>
                            </select>
                        </div>
                        <div>
                            <label for="availability">Availability:</label>
                            <select id="availability">
                                <option value="1">1 - Minimal</option>
                                <option value="2">2 - Low</option>
                                <option value="3" selected>3 - Moderate</option>
                                <option value="4">4 - High</option>
                                <option value="5">5 - Critical</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-divider"></div>

            <!-- Step 3: Assess Current Risk -->
            <div class="workflow-section">
                <h2>Step 3: Assess Current Risk</h2>
                
                <div class="risk-matrix">
                    <div class="form-group">
                        <label for="likelihood">Likelihood:</label>
                        <select id="likelihood">
                            <option value="5">1 - Almost Certain (multiple times per year)</option>
                            <option value="4">2 - Likely (at least once per year)</option>
                            <option value="3" selected>3 - Possible (once between 1-5 years)</option>
                            <option value="2">2 - Unlikely (once between 5-10 years)</option>
                            <option value="1">1 - Rare (perhaps once in 10 years)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="impact">Impact:</label>
                        <select id="impact">
                            <option value="5">1 - Extreme impact on C/I/A</option>
                            <option value="4" selected>2 - Major impact on C/I/A</option>
                            <option value="3">3 - Moderate impact on C/I/A</option>
                            <option value="2">4 - Minor impact on C/I/A</option>
                            <option value="1">5 - Insignificant impact on C/I/A</option>
                        </select>
                    </div>
                </div>

                <div class="risk-calculation">
                    <h3>Current Risk Assessment</h3>
                    <div class="risk-score" id="currentRiskScore">Risk Score: 12</div>
                    <div id="currentRiskLevel">High Risk</div>
                </div>

                <button class="btn btn-primary" onclick="calculateCurrentRisk()">Calculate Current Risk</button>
            </div>

            <div class="section-divider"></div>

            <!-- Step 4: Apply Compensating Controls -->
            <div class="workflow-section">
                <h2>Step 4: Apply Compensating Controls</h2>
                
                <div class="controls-section">
                    <h3>Available Compensating Controls</h3>
                    <div class="controls-grid" id="controlsGrid">
                        <!-- Controls will be dynamically populated -->
                    </div>
                </div>

                <button class="btn btn-success" onclick="applyCompensatingControls()">Apply Selected Controls</button>
            </div>

            <div class="section-divider"></div>

            <!-- Step 5: Compare Risks -->
            <div class="workflow-section">
                <h2>Step 5: Risk Comparison & Analysis</h2>
                
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Assessment</th>
                            <th>Likelihood</th>
                            <th>Impact</th>
                            <th>Risk Score</th>
                            <th>Risk Level</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Before Controls</strong></td>
                            <td id="beforeLikelihood">3</td>
                            <td id="beforeImpact">4</td>
                            <td id="beforeScore">12</td>
                            <td id="beforeLevel">High Risk</td>
                        </tr>
                        <tr>
                            <td><strong>After Controls</strong></td>
                            <td id="afterLikelihood">-</td>
                            <td id="afterImpact">-</td>
                            <td id="afterScore">-</td>
                            <td id="afterLevel">-</td>
                        </tr>
                    </tbody>
                </table>

                <div class="gap-analysis hidden" id="gapAnalysis">
                    <h3>üîç Gap Analysis</h3>
                    <div id="gapContent"></div>
                </div>

                <div class="ofi-section hidden" id="ofiSection">
                    <h3>üí° Opportunities for Improvement (OFI)</h3>
                    <div id="ofiContent"></div>
                </div>
            </div>

            <div class="section-divider"></div>

            <!-- Step 6: Document & Export -->
            <div class="workflow-section">
                <h2>Step 6: Document & Export</h2>
                
                <div class="form-group">
                    <label for="assessmentNotes">Assessment Notes:</label>
                    <textarea id="assessmentNotes" rows="4" placeholder="Additional notes, recommendations, or observations..."></textarea>
                </div>

                <button class="btn btn-success" onclick="exportAssessment()">üìÑ Export Assessment</button>
                <button class="btn btn-primary" onclick="saveSession()">üíæ Save Session</button>
                <button class="btn btn-warning" onclick="loadSession()">üìÇ Load Session</button>
            </div>
        </div>
    </div>

    <script>
        // Default NIST CSF 2.0 Controls Data
        const defaultControls = {
            preventative: [
                { id: 'ID.AM', name: 'Asset Management', description: 'Identify and manage organizational assets', riskReduction: { likelihood: 0.5, impact: 0.2 } },
                { id: 'PR.AC', name: 'Identity & Access Control', description: 'Limit access to authorized users and processes', riskReduction: { likelihood: 0.7, impact: 0.3 } },
                { id: 'PR.AT', name: 'Awareness & Training', description: 'Provide cybersecurity education', riskReduction: { likelihood: 0.6, impact: 0.1 } },
                { id: 'PR.DS', name: 'Data Security', description: 'Protect data through appropriate safeguards', riskReduction: { likelihood: 0.4, impact: 0.5 } },
                { id: 'PR.IP', name: 'Information Protection', description: 'Maintain protective technology', riskReduction: { likelihood: 0.5, impact: 0.4 } },
                { id: 'PR.MA', name: 'Maintenance', description: 'Perform maintenance on systems', riskReduction: { likelihood: 0.3, impact: 0.2 } },
                { id: 'PR.PT', name: 'Protective Technology', description: 'Deploy technical security solutions', riskReduction: { likelihood: 0.8, impact: 0.3 } }
            ],
            mitigative: [
                { id: 'DE.AE', name: 'Anomalies & Events', description: 'Detect anomalous activity', riskReduction: { likelihood: 0.2, impact: 0.6 } },
                { id: 'DE.CM', name: 'Continuous Monitoring', description: 'Monitor systems continuously', riskReduction: { likelihood: 0.3, impact: 0.4 } },
                { id: 'RS.RP', name: 'Response Planning', description: 'Execute response procedures', riskReduction: { likelihood: 0.1, impact: 0.7 } },
                { id: 'RS.CO', name: 'Communications', description: 'Coordinate response activities', riskReduction: { likelihood: 0.2, impact: 0.5 } },
                { id: 'RS.AN', name: 'Analysis', description: 'Analyze events to understand impact', riskReduction: { likelihood: 0.1, impact: 0.6 } },
                { id: 'RC.RP', name: 'Recovery Planning', description: 'Execute recovery procedures', riskReduction: { likelihood: 0.1, impact: 0.8 } },
                { id: 'RC.IM', name: 'Improvements', description: 'Incorporate lessons learned', riskReduction: { likelihood: 0.4, impact: 0.3 } }
            ]
        };

        let currentAssessment = {
            finding: {},
            currentRisk: {},
            selectedControls: [],
            adjustedRisk: {},
            gaps: [],
            ofis: []
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadDefaultControls();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('jsonUpload').addEventListener('change', loadCustomConfiguration);
            document.getElementById('likelihood').addEventListener('change', calculateCurrentRisk);
            document.getElementById('impact').addEventListener('change', calculateCurrentRisk);
        }

        function loadDefaultControls() {
            const controlsGrid = document.getElementById('controlsGrid');
            controlsGrid.innerHTML = '';

            // Add preventative controls
            defaultControls.preventative.forEach(control => {
                const controlElement = createControlElement(control, 'preventative');
                controlsGrid.appendChild(controlElement);
            });

            // Add mitigative controls
            defaultControls.mitigative.forEach(control => {
                const controlElement = createControlElement(control, 'mitigative');
                controlsGrid.appendChild(controlElement);
            });
        }

        function createControlElement(control, type) {
            const div = document.createElement('div');
            div.className = 'control-item';
            div.innerHTML = `
                <input type="checkbox" id="${control.id}" data-type="${type}">
                <label for="${control.id}">
                    <strong>${control.id}: ${control.name}</strong><br>
                    <small>${control.description}</small><br>
                    <em>Risk Reduction: L(-${Math.round(control.riskReduction.likelihood * 100)}%) I(-${Math.round(control.riskReduction.impact * 100)}%)</em>
                </label>
            `;

            div.addEventListener('click', function(e) {
                if (e.target.type !== 'checkbox') {
                    const checkbox = div.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                }
                div.classList.toggle('selected', div.querySelector('input[type="checkbox"]').checked);
            });

            return div;
        }

        function calculateCurrentRisk() {
            const likelihood = parseInt(document.getElementById('likelihood').value);
            const impact = parseInt(document.getElementById('impact').value);
            const riskScore = likelihood * impact;
            
            currentAssessment.currentRisk = {
                likelihood: likelihood,
                impact: impact,
                score: riskScore,
                level: getRiskLevel(riskScore)
            };

            document.getElementById('currentRiskScore').textContent = `Risk Score: ${riskScore}`;
            document.getElementById('currentRiskLevel').textContent = currentAssessment.currentRisk.level;
            document.getElementById('currentRiskScore').className = `risk-score ${getRiskClass(riskScore)}`;

            // Update comparison table
            document.getElementById('beforeLikelihood').textContent = likelihood;
            document.getElementById('beforeImpact').textContent = impact;
            document.getElementById('beforeScore').textContent = riskScore;
            document.getElementById('beforeLevel').textContent = currentAssessment.currentRisk.level;
        }

        function getRiskLevel(score) {
            if (score >= 20) return 'Very High Risk';
            if (score >= 15) return 'High Risk';
            if (score >= 10) return 'Medium Risk';
            if (score >= 5) return 'Low Risk';
            return 'Very Low Risk';
        }

        function getRiskClass(score) {
            if (score >= 20) return 'risk-very-high';
            if (score >= 15) return 'risk-high';
            if (score >= 10) return 'risk-medium';
            if (score >= 5) return 'risk-low';
            return 'risk-very-low';
        }

        function applyCompensatingControls() {
            // Collect selected controls
            const selectedCheckboxes = document.querySelectorAll('.control-item input[type="checkbox"]:checked');
            currentAssessment.selectedControls = [];

            let totalLikelihoodReduction = 0;
            let totalImpactReduction = 0;

            selectedCheckboxes.forEach(checkbox => {
                const controlId = checkbox.id;
                const controlType = checkbox.dataset.type;
                const control = [...defaultControls.preventative, ...defaultControls.mitigative]
                    .find(c => c.id === controlId);
                
                if (control) {
                    currentAssessment.selectedControls.push(control);
                    totalLikelihoodReduction += control.riskReduction.likelihood;
                    totalImpactReduction += control.riskReduction.impact;
                }
            });

            // Calculate adjusted risk with diminishing returns
            const likelihoodMultiplier = Math.max(0.1, 1 - Math.min(0.8, totalLikelihoodReduction));
            const impactMultiplier = Math.max(0.1, 1 - Math.min(0.8, totalImpactReduction));

            const adjustedLikelihood = Math.max(1, Math.round(currentAssessment.currentRisk.likelihood * likelihoodMultiplier));
            const adjustedImpact = Math.max(1, Math.round(currentAssessment.currentRisk.impact * impactMultiplier));
            const adjustedScore = adjustedLikelihood * adjustedImpact;

            currentAssessment.adjustedRisk = {
                likelihood: adjustedLikelihood,
                impact: adjustedImpact,
                score: adjustedScore,
                level: getRiskLevel(adjustedScore)
            };

            // Update comparison table
            document.getElementById('afterLikelihood').textContent = adjustedLikelihood;
            document.getElementById('afterImpact').textContent = adjustedImpact;
            document.getElementById('afterScore').textContent = adjustedScore;
            document.getElementById('afterLevel').textContent = currentAssessment.adjustedRisk.level;

            // Perform gap analysis
            performGapAnalysis();
            generateOFIs();
        }

        function performGapAnalysis() {
            const gapAnalysis = document.getElementById('gapAnalysis');
            const gapContent = document.getElementById('gapContent');
            
            let gaps = [];

            // Check if risk is still high after controls
            if (currentAssessment.adjustedRisk.score >= 15) {
                gaps.push('Risk remains HIGH even after applying compensating controls. Additional controls may be required.');
            }

            // Check for missing control categories
            const selectedTypes = new Set(currentAssessment.selectedControls.map(c => {
                return [...defaultControls.preventative, ...defaultControls.mitigative]
                    .find(dc => dc.id === c.id) ? 
                    (defaultControls.preventative.find(dc => dc.id === c.id) ? 'preventative' : 'mitigative') : null;
            }));

            if (!selectedTypes.has('preventative')) {
                gaps.push('No preventative controls selected. Consider implementing ID.AM, PR.AC, or PR.PT controls.');
            }

            if (!selectedTypes.has('mitigative')) {
                gaps.push('No mitigative/reactive controls selected. Consider implementing DE.AE, RS.RP, or RC.RP controls.');
            }

            // Check for specific high-impact gaps
            const hasAccessControl = currentAssessment.selectedControls.some(c => c.id === 'PR.AC');
            const hasMonitoring = currentAssessment.selectedControls.some(c => c.id === 'DE.AE' || c.id === 'DE.CM');
            
            if (!hasAccessControl && currentAssessment.currentRisk.impact >= 4) {
                gaps.push('High-impact finding lacks Identity & Access Control (PR.AC) - critical gap for this threat type.');
            }

            if (!hasMonitoring && currentAssessment.currentRisk.likelihood >= 4) {
                gaps.push('High-likelihood finding lacks continuous monitoring (DE.AE/DE.CM) - detection gap identified.');
            }

            currentAssessment.gaps = gaps;

            if (gaps.length > 0) {
                gapContent.innerHTML = gaps.map(gap => `<p>‚ö†Ô∏è ${gap}</p>`).join('');
                gapAnalysis.classList.remove('hidden');
            } else {
                gapAnalysis.classList.add('hidden');
            }
        }

        function generateOFIs() {
            const ofiSection = document.getElementById('ofiSection');
            const ofiContent = document.getElementById('ofiContent');
            
            let ofis = [];

            // Risk reduction opportunities
            const riskReduction = currentAssessment.currentRisk.score - currentAssessment.adjustedRisk.score;
            if (riskReduction > 0) {
                ofis.push(`Implemented controls achieved ${Math.round((riskReduction / currentAssessment.currentRisk.score) * 100)}% risk reduction. Consider standardizing these controls across similar assets.`);
            }

            // Suggest additional controls based on remaining risk
            if (currentAssessment.adjustedRisk.score >= 10) {
                const missingControls = [...defaultControls.preventative, ...defaultControls.mitigative]
                    .filter(c => !currentAssessment.selectedControls.some(sc => sc.id === c.id))
                    .sort((a, b) => (b.riskReduction.likelihood + b.riskReduction.impact) - (a.riskReduction.likelihood + a.riskReduction.impact))
                    .slice(0, 3);

                if (missingControls.length > 0) {
                    ofis.push(`Consider implementing these high-impact controls: ${missingControls.map(c => c.id + ' (' + c.name + ')').join(', ')}`);
                }
            }

            // Asset-specific recommendations
            const confidentiality = parseInt(document.getElementById('confidentiality').value);
            const integrity = parseInt(document.getElementById('integrity').value);
            const availability = parseInt(document.getElementById('availability').value);

            if (confidentiality >= 4 && !currentAssessment.selectedControls.some(c => c.id === 'PR.DS')) {
                ofis.push('High confidentiality asset should implement enhanced Data Security (PR.DS) controls.');
            }

            if (availability >= 4 && !currentAssessment.selectedControls.some(c => c.id === 'RC.RP')) {
                ofis.push('High availability asset requires robust Recovery Planning (RC.RP) capabilities.');
            }

            // Control maturity recommendations
            if (currentAssessment.selectedControls.length < 3) {
                ofis.push('Limited compensating controls identified. Consider expanding control coverage across preventative and reactive categories.');
            }

            currentAssessment.ofis = ofis;

            if (ofis.length > 0) {
                ofiContent.innerHTML = ofis.map(ofi => `<p>üí° ${ofi}</p>`).join('');
                ofiSection.classList.remove('hidden');
            } else {
                ofiSection.classList.add('hidden');
            }
        }

        function loadCustomConfiguration(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const customConfig = JSON.parse(e.target.result);
                    
                    // Update bow tie visualization with custom data
                    if (customConfig.threats) {
                        document.getElementById('threatsContent').innerHTML = formatConfigContent(customConfig.threats);
                    }
                    if (customConfig.preventativeControls) {
                        document.getElementById('preventativeContent').innerHTML = formatConfigContent(customConfig.preventativeControls);
                    }
                    if (customConfig.incidents) {
                        document.getElementById('incidentContent').innerHTML = formatConfigContent(customConfig.incidents);
                    }
                    if (customConfig.mitigativeControls) {
                        document.getElementById('mitigativeContent').innerHTML = formatConfigContent(customConfig.mitigativeControls);
                    }
                    if (customConfig.consequences) {
                        document.getElementById('consequencesContent').innerHTML = formatConfigContent(customConfig.consequences);
                    }

                    // Update controls if provided
                    if (customConfig.controls) {
                        updateControlsFromConfig(customConfig.controls);
                    }

                    alert('‚úÖ Custom configuration loaded successfully!');
                } catch (error) {
                    alert('‚ùå Error parsing JSON file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function formatConfigContent(items) {
            if (Array.isArray(items)) {
                return items.map(item => `‚Ä¢ ${item}`).join('<br>');
            } else if (typeof items === 'object') {
                return Object.entries(items).map(([key, value]) => `<strong>${key}:</strong> ${value}`).join('<br>');
            }
            return items.toString();
        }

        function updateControlsFromConfig(customControls) {
            const controlsGrid = document.getElementById('controlsGrid');
            controlsGrid.innerHTML = '';

            ['preventative', 'mitigative'].forEach(type => {
                if (customControls[type]) {
                    customControls[type].forEach(control => {
                        // Ensure control has required properties
                        const controlObj = {
                            id: control.id || `CUSTOM_${Math.random().toString(36).substr(2, 9)}`,
                            name: control.name || 'Custom Control',
                            description: control.description || 'Custom control description',
                            riskReduction: control.riskReduction || { likelihood: 0.3, impact: 0.3 }
                        };
                        
                        const controlElement = createControlElement(controlObj, type);
                        controlsGrid.appendChild(controlElement);
                    });
                }
            });
        }

        function exportAssessment() {
            // Collect all assessment data
            const assessmentData = {
                finding: {
                    title: document.getElementById('findingTitle').value,
                    description: document.getElementById('findingDescription').value,
                    asset: document.getElementById('assetName').value,
                    cia: {
                        confidentiality: document.getElementById('confidentiality').value,
                        integrity: document.getElementById('integrity').value,
                        availability: document.getElementById('availability').value
                    }
                },
                riskAssessment: {
                    current: currentAssessment.currentRisk,
                    adjusted: currentAssessment.adjustedRisk,
                    selectedControls: currentAssessment.selectedControls
                },
                analysis: {
                    gaps: currentAssessment.gaps,
                    ofis: currentAssessment.ofis,
                    notes: document.getElementById('assessmentNotes').value
                },
                metadata: {
                    assessmentDate: new Date().toISOString(),
                    tool: 'Bow Tie Risk Assessment Tool v1.0'
                }
            };

            // Create downloadable report
            const reportContent = generateReport(assessmentData);
            const blob = new Blob([reportContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `bow_tie_assessment_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Also generate human-readable report
            generateHumanReadableReport(assessmentData);
        }

        function generateReport(data) {
            return JSON.stringify(data, null, 2);
        }

        function generateHumanReadableReport(data) {
            const report = `
# Bow Tie Risk Assessment Report

## Finding Details
**Title:** ${data.finding.title}
**Asset:** ${data.finding.asset}
**Description:** ${data.finding.description}

## Asset Classification (CIA)
- **Confidentiality:** ${data.finding.cia.confidentiality}/5
- **Integrity:** ${data.finding.cia.integrity}/5
- **Availability:** ${data.finding.cia.availability}/5

## Risk Assessment
### Current Risk (Before Controls)
- **Likelihood:** ${data.riskAssessment.current.likelihood}/5
- **Impact:** ${data.riskAssessment.current.impact}/5
- **Risk Score:** ${data.riskAssessment.current.score}
- **Risk Level:** ${data.riskAssessment.current.level}

### Adjusted Risk (After Controls)
- **Likelihood:** ${data.riskAssessment.adjusted.likelihood}/5
- **Impact:** ${data.riskAssessment.adjusted.impact}/5
- **Risk Score:** ${data.riskAssessment.adjusted.score}
- **Risk Level:** ${data.riskAssessment.adjusted.level}

## Applied Compensating Controls
${data.riskAssessment.selectedControls.map(c => `- **${c.id}:** ${c.name} - ${c.description}`).join('\n')}

## Gap Analysis
${data.analysis.gaps.length > 0 ? data.analysis.gaps.map(gap => `- ${gap}`).join('\n') : 'No significant gaps identified.'}

## Opportunities for Improvement
${data.analysis.ofis.length > 0 ? data.analysis.ofis.map(ofi => `- ${ofi}`).join('\n') : 'No specific opportunities identified.'}

## Additional Notes
${data.analysis.notes || 'No additional notes provided.'}

---
*Report generated on ${new Date().toLocaleDateString()} using Bow Tie Risk Assessment Tool*
            `;

            const blob = new Blob([report], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `bow_tie_assessment_report_${new Date().toISOString().split('T')[0]}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('üìÑ Assessment exported successfully! Both JSON data and markdown report have been downloaded.');
        }

        function saveSession() {
            const sessionData = {
                finding: {
                    title: document.getElementById('findingTitle').value,
                    description: document.getElementById('findingDescription').value,
                    asset: document.getElementById('assetName').value,
                    cia: {
                        confidentiality: document.getElementById('confidentiality').value,
                        integrity: document.getElementById('integrity').value,
                        availability: document.getElementById('availability').value
                    }
                },
                risk: {
                    likelihood: document.getElementById('likelihood').value,
                    impact: document.getElementById('impact').value
                },
                selectedControls: Array.from(document.querySelectorAll('.control-item input[type="checkbox"]:checked')).map(cb => cb.id),
                notes: document.getElementById('assessmentNotes').value,
                timestamp: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(sessionData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `bow_tie_session_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('üíæ Session saved successfully!');
        }

        function loadSession() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const sessionData = JSON.parse(e.target.result);
                        
                        // Restore form values
                        document.getElementById('findingTitle').value = sessionData.finding.title || '';
                        document.getElementById('findingDescription').value = sessionData.finding.description || '';
                        document.getElementById('assetName').value = sessionData.finding.asset || '';
                        document.getElementById('confidentiality').value = sessionData.finding.cia.confidentiality || '3';
                        document.getElementById('integrity').value = sessionData.finding.cia.integrity || '3';
                        document.getElementById('availability').value = sessionData.finding.cia.availability || '3';
                        document.getElementById('likelihood').value = sessionData.risk.likelihood || '3';
                        document.getElementById('impact').value = sessionData.risk.impact || '4';
                        document.getElementById('assessmentNotes').value = sessionData.notes || '';

                        // Restore selected controls
                        document.querySelectorAll('.control-item input[type="checkbox"]').forEach(cb => {
                            cb.checked = sessionData.selectedControls.includes(cb.id);
                            cb.closest('.control-item').classList.toggle('selected', cb.checked);
                        });

                        // Recalculate risk
                        calculateCurrentRisk();

                        alert('üìÇ Session loaded successfully!');
                    } catch (error) {
                        alert('‚ùå Error loading session: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Auto-calculate risk when page loads
        calculateCurrentRisk();
    </script>
</body>
</html>